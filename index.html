<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบวิทยาศาสตร์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
    <style>
        body {
            font-family: 'Itim', sans-serif;
        }

        .answer-option.correct {
            background-color: #10B981 !important;
            color: white !important;
            border-color: #059669 !important;
        }

        #quiz-container {
            height: 100vh;
            width: 100vw;
            max-width: 100vw;
            border-radius: 0;
            box-shadow: inset;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
        }

        #main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            gap: 2rem;
        }

        #image-container img {
            max-height: 90%;
            object-fit: contain;
            width: 100%;
        }

        #qa-container {
            display: flex;
            height: 100%;
        }

        #image-container {
            display: none;
        }

        #qa-container {
            width: 100%;
        }

        .format-1 #qa-container {
            flex-direction: column;
        }

        .format-1 #question-wrapper {
            flex-basis: 40%;
        }

        .format-1 #answer-options {
            flex-basis: 60%;
        }

        .format-2 #qa-container {
            flex-direction: row;
            align-items: center;
            gap: 2rem;
        }

        .format-2 #question-wrapper,
        .format-2 #answer-options {
            flex-basis: 50%;
            height: 100%;
        }

        .format-3 {
            flex-direction: column;
        }

        .format-3 #image-container {
            display: flex;
            width: 100%;
            height: 50%;
        }

        .format-3 #qa-container {
            width: 100%;
            height: 50%;
            flex-direction: column;
        }

        .format-3 #question-wrapper {
            flex-basis: 40%;
        }

        .format-3 #answer-options {
            flex-basis: 60%;
        }

        .format-4 {
            flex-direction: row;
        }

        .format-4 #image-container {
            display: flex;
            width: 50%;
            height: 100%;
        }

        .format-4 #qa-container {
            width: 50%;
            height: 100%;
            flex-direction: column;
        }

        .format-4 #question-wrapper {
            flex-basis: 40%;
        }

        .format-4 #answer-options {
            flex-basis: 60%;
        }

        #question-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #answer-options {
            display: grid;
            align-content: center;
            gap: 1.5rem;
        }

        #question-text {
            font-size: clamp(5rem, 8vh, 5rem);
            line-height: 1.2;
            padding: 1.3rem;
            font-weight: 550;
            padding: clamp(3rem, 2vh, 10rem);
            background-color: rgb(255, 255, 255);
        }

        .answer-option {
            font-size: clamp(3.3rem, 5vh, 4.1rem);
            padding: clamp(3rem, 2vh, 10rem);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
            font-weight: 500;
            background-color: rgb(240, 226, 180);
        }

        #question-text svg {
            display: inline;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-0 overflow-hidden">

    <div id="quiz-container" class="bg-white p-6 md:p-8 w-full">
        <!-- Header -->
        <div class="flex-shrink-0">
            <div class="flex justify-end items-center mb-4 gap-4">
                <div class="flex items-center gap-4 md:gap-6">
                    <div id="timer" class="text-3xl md:text-4xl font-bold"></div>
                    <div id="question-counter" class="text-lg md:text-xl font-semibold text-gray-600"></div>
                </div>
                <button id="fullscreen-btn" title="โหมดเต็มจอ"
                    class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="text-gray-600">
                        <path
                            d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                        </path>
                    </svg>
                    <svg id="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="text-gray-600 hidden">
                        <path
                            d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0-2-2h-3M3 16h3a2 2 0 0 0 2-2v-3">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area (Image + Q&A) -->
        <div id="main-content" class="flex">
            <!-- Image Container -->
            <div id="image-container">
                <img id="question-image" src="" alt="รูปประกอบคำถาม" class="rounded-lg">
            </div>

            <!-- Q&A Container -->
            <div id="qa-container">
                <!-- Question Area -->
                <div id="question-wrapper">
                    <p id="question-text" class="text-gray-800"></p>
                </div>

                <!-- Answer Options -->
                <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2">
                    <!-- Options will be inserted here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex-shrink-0">
            <div class="flex flex-col md:flex-row items-center justify-between mt-8 pt-6 border-t border-gray-200">
                <button id="show-answer-btn"
                    class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 mb-4 md:mb-0 text-lg">
                    เฉลย
                </button>
                <div class="flex gap-4">
                    <button id="prev-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300 text-lg">
                        ก่อนหน้า
                    </button>
                    <button id="next-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300 text-lg">
                        ถัดไป
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import quizData from './question/quiz-data.js';

        // DOM Elements
        const mainContent = document.getElementById('main-content');
        const questionCounterEl = document.getElementById('question-counter');
        const questionTextEl = document.getElementById('question-text');
        const answerOptionsEl = document.getElementById('answer-options');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const timerEl = document.getElementById('timer');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const fullscreenIcon = document.getElementById('fullscreen-icon');
        const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
        const imageContainer = document.getElementById('image-container');
        const questionImage = document.getElementById('question-image');
        const qaContainer = document.getElementById('qa-container');

        // State variables
        let currentQuestionIndex = 0;
        let timerInterval;
        const TIME_LIMIT = 30;
        let audioCtx;

        // --- Fullscreen Functions ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function updateFullscreenIcon() {
            if (document.fullscreenElement) {
                fullscreenIcon.classList.add('hidden');
                exitFullscreenIcon.classList.remove('hidden');
            } else {
                fullscreenIcon.classList.remove('hidden');
                exitFullscreenIcon.classList.add('hidden');
            }
        }

        // --- Sound and Timer Functions ---
        function playTimeoutSound() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioCtx) {
                    console.error("Web Audio API is not supported in this browser.");
                    return;
                }
            }

            let alarmInterval;
            let note = 0;
            const frequencies = [880, 660];

            const playBeep = () => {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(frequencies[note % 2], audioCtx.currentTime);

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.15);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.15);

                note++;
            };

            alarmInterval = setInterval(playBeep, 200);

            setTimeout(() => {
                clearInterval(alarmInterval);
            }, 3000);
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = TIME_LIMIT;

            timerEl.textContent = timeLeft;
            timerEl.classList.remove('text-red-500', 'animate-pulse');
            timerEl.classList.add('text-green-600');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;

                if (timeLeft <= 10) {
                    timerEl.classList.remove('text-green-600');
                    timerEl.classList.add('text-red-500', 'animate-pulse');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    playTimeoutSound();
                    const options = answerOptionsEl.children;
                    for (let i = 0; i < options.length; i++) {
                        options[i].disabled = true;
                        options[i].classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }, 1000);
        }

        // --- Quiz Functions ---
        function displayQuestion() {
            answerOptionsEl.innerHTML = '';
            showAnswerBtn.disabled = false;

            startTimer();

            const questionData = quizData[currentQuestionIndex];
            const format = questionData.questionFormat || 1;

            questionTextEl.innerHTML = questionData.question; // Use innerHTML for LaTeX/HTML
            questionCounterEl.textContent = `ข้อที่ ${currentQuestionIndex + 1} / ${quizData.length}`;

            mainContent.className = `flex flex-grow min-h-0 format-${format}`;

            if (format === 3 || format === 4) {
                questionImage.src = questionData.imageUrl;
                questionImage.onerror = () => { questionImage.src = 'https://placehold.co/600x600/ccc/FFFFFF?text=Image+Not+Found'; };
            }

            const prefixes = ['ก.', 'ข.', 'ค.', 'ง.'];
            questionData.answerOptions.forEach((option, index) => {
                const optionEl = document.createElement('button');
                optionEl.innerHTML = `${prefixes[index]} ${option.text}`; // Use innerHTML for LaTeX/HTML
                optionEl.classList.add('answer-option', 'w-full', 'p-4', 'border-2', 'border-gray-300', 'rounded-lg', 'hover:bg-gray-100', 'hover:border-blue-400', 'transition-colors', 'duration-300');
                answerOptionsEl.appendChild(optionEl);
            });

            if (window.MathJax) {
                MathJax.typesetPromise([questionTextEl, answerOptionsEl]).catch((err) => console.log(err.message));
            }

            updateNavButtons();
        }

        function showAnswer() {
            clearInterval(timerInterval);

            const questionData = quizData[currentQuestionIndex];
            const options = answerOptionsEl.children;

            for (let i = 0; i < options.length; i++) {
                if (questionData.answerOptions[i].isCorrect) {
                    options[i].classList.add('correct');
                }
                options[i].disabled = true;
            }

            showAnswerBtn.disabled = true;
        }

        function updateNavButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === quizData.length - 1;

            [prevBtn, nextBtn].forEach(btn => {
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // --- Event Listeners ---
        showAnswerBtn.addEventListener('click', showAnswer);
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', updateFullscreenIcon);

        nextBtn.addEventListener('click', () => {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        });

        // --- Initial Setup ---
        window.onload = () => {
            displayQuestion();
        };

    </script>
</body>

</html>